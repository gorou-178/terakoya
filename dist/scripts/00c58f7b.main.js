function newCanvas(){var a='<canvas id="canvas" width="345px" height="250px"></canvas>';$("#drawCanvas").html(a),ctx=document.getElementById("canvas").getContext("2d"),ctx.strokeStyle=color,ctx.lineWidth=3,$("#canvas").drawTouch(),$("#canvas").drawPointer(),$("#canvas").drawMouse()}var ctx,color="black",socket,localStream,peerConnection=void 0,CR=String.fromCharCode(13),localVideo=document.getElementById("local-video"),remoteVideo=document.getElementById("remote-video");$.fn.drawTouch=function(){var a=function(a){a=a.originalEvent,ctx.beginPath(),x=a.changedTouches[0].pageX,y=a.changedTouches[0].pageY,ctx.moveTo(x,y)},b=function(a){a.preventDefault(),a=a.originalEvent,x=a.changedTouches[0].pageX,y=a.changedTouches[0].pageY,ctx.lineTo(x,y),ctx.stroke()};$(this).on("touchstart",a),$(this).on("touchmove",b)},$.fn.drawPointer=function(){var a=function(a){a=a.originalEvent,ctx.beginPath(),x=a.pageX,y=a.pageY,ctx.moveTo(x,y)},b=function(a){a.preventDefault(),a=a.originalEvent,x=a.pageX,y=a.pageY,ctx.lineTo(x,y),ctx.stroke()};$(this).on("MSPointerDown",a),$(this).on("MSPointerMove",b)},$.fn.drawMouse=function(){var a=0,b=function(b){a=1,ctx.beginPath(),x=b.offsetX,y=b.offsetY,ctx.moveTo(x,y),socket.emit("message",{act:"down",x:x,y:y,color:ctx.strokeStyle})},c=function(b){a&&(x=b.offsetX,y=b.offsetY,ctx.lineTo(x,y),ctx.stroke(),socket.emit("message",{act:"move",x:x,y:y}))},d=function(){a=0};$(this).on("mousedown",b),$(this).on("mousemove",c),$(window).on("mouseup",d)},$(function(){{var a=new Vue({el:".chat",data:{username:"",message:"",chats:[]},created:function(){console.log("chatHistory created"),this.username="ゲスト"+Math.floor(100*Math.random())},ready:function(){console.log("chatHistory ready")},methods:{addChat:function(a){var b=$.format.date((new Date).getTime(),"yyyyMMddHHmmss");this.chats.unshift({name:this.username,message:a,date:b})},send:function(a){a.preventDefault(),_.isEmpty(this.message)||(this.addChat(this.message),socket.emit("message",{act:"chat",username:this.username,message:this.message}),this.reset())},reset:function(){this.message=""}}}),b=new Vue({el:".live-video-box",template:"#live-video-tmpl",data:{socketReady:!1,port:5e3,sendSdp:"",sendIce:"",receiveSdp:"",receiveIce:"",iceSeparator:"------ ICE Candidate -------",peerStarted:!1,remote_down:!1,timer:void 0,mediaConstraints:{mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!0}}},ready:function(){this.init()},methods:{onOpend:function(){console.log("socket opened"),b.socketReady=!0,b.startVideo()},onMessage:function(c){if(console.log("socket message"),"offer"===c.type)console.log("Received offer, set offer, sending answer...."),b.onOffer(c);else if("answer"===c.type&&b.peerStarted)console.log("Received answer, settinng answer SDP"),b.onAnswer(c);else if("candidate"===c.type&&b.peerStarted)console.log("Received ICE candidate..."),b.onCandidate(c);else if("user dissconnected"===c.type&&b.peerStarted)console.log("disconnected"),b.stop();else switch(c.act){case"down":b.remote_down=!0,ctx.strokeStyle=c.color,ctx.beginPath(),ctx.moveTo(c.x,c.y);break;case"move":console.log("remote: "+c.x,c.y),ctx.lineTo(c.x,c.y),ctx.stroke();break;case"up":if(!b.remote_down)return;ctx.lineTo(c.x,c.y),ctx.stroke(),ctx.closePath(),b.remote_down=!1;break;case"chat":a.addChat(c.message);break;default:console.log("このアクションはサポートしていません")}},init:function(){socket=io.connect("https://terakoya-signaling.herokuapp.com:"+this.port+"/"),socket.on("connect",this.onOpend).on("message",this.onMessage)},onSDP:function(a){var a=JSON.parse(this.receiveSdp);peerConnection?this.onAnswer(a):this.onOffer(a),this.receiveSdp=""},onICE:function(){for(var a=this.receiveIce,b=a.split(iceSeparator),c=1,d=b.length;d>c;c++){var e=JSON.parse(b[c]);this.onCandidate(e)}this.receiveIce=""},onOffer:function(a){console.log("Received offer..."),console.log(a),this.setOffer(a),this.sendAnswer(a),this.peerStarted=!0},onAnswer:function(a){console.log("Received Answer..."),console.log(a),this.setAnswer(a)},onCandidate:function(a){var b=new RTCIceCandidate({sdpMLineIndex:a.sdpMLineIndex,sdpMid:a.sdpMid,candidate:a.candidate});console.log("Received Candidate..."),console.log(b),clearInterval(this.timer),peerConnection.addIceCandidate(b)},sendSDP:function(a){var b=JSON.stringify(a);console.log("---sending sdp text ---"),console.log(b),this.sendSdp=b,socket.json.send(a)},sendCandidate:function(a){var b=JSON.stringify(a);console.log("---sending candidate text ---"),console.log(b),this.sendIce=this.sendIce+CR+this.iceSeparator+CR+b+CR,socket.json.send(a)},startVideo:function(){navigator.webkitGetUserMedia({video:!0,audio:!0},function(a){console.log("getUserMedia success"),localStream=a,localVideo.src=window.webkitURL.createObjectURL(a),localVideo.play(),localVideo.volume=0,b.tryConnect()},function(a){console.error("An error occurred: [CODE "+a.code+"]")})},tryConnect:function(){var a=this;this.timer=setInterval(function(){a.connect()},5e3)},stopVideo:function(){localVideo.src="",localStream.stop()},prepareNewConnection:function(){var a={iceServers:[]},b=null;try{b=new webkitRTCPeerConnection(a)}catch(c){return void console.log("Failed to create peerConnection, exception: "+c.message)}var d=this;return b.onicecandidate=function(a){a.candidate?(console.log(a.candidate),d.sendCandidate({type:"candidate",sdpMLineIndex:a.candidate.sdpMLineIndex,sdpMid:a.candidate.sdpMid,candidate:a.candidate.candidate})):console.log("End of candidates. ------------------- phase="+a.eventPhase)},console.log("Adding local stream..."),b.addStream(localStream),b.addEventListener("addstream",this.onRemoteStreamAdded,!1),b.addEventListener("removestream",this.onRemoteStreamRemoved,!1),b},onRemoteStreamAdded:function(a){console.log("Added remote stream"),clearInterval(this.timer),remoteVideo.src=window.webkitURL.createObjectURL(a.stream)},onRemoteStreamRemoved:function(){console.log("Remove remote stream"),remoteVideo.src=""},sendOffer:function(){var a=this;return peerConnection=this.prepareNewConnection(),_.isUndefined(peerConnection)?void console.log("prepareNewConnection fail"):void peerConnection.createOffer(function(b){peerConnection.setLocalDescription(b),console.log("Sending: SDP"),console.log(b),a.sendSDP(b)},function(){console.log("Create Offer failed")},this.mediaConstraints)},setOffer:function(a){peerConnection&&console.error("peerConnection alreay exist!"),peerConnection=this.prepareNewConnection(),peerConnection.setRemoteDescription(new RTCSessionDescription(a))},sendAnswer:function(){if(console.log("sending Answer. Creating remote session description..."),!peerConnection)return void console.error("peerConnection NOT exist!");var a=this;peerConnection.createAnswer(function(b){peerConnection.setLocalDescription(b),console.log("Sending: SDP"),console.log(b),a.sendSDP(b)},function(){console.log("Create Answer failed")},this.mediaConstraints)},setAnswer:function(a){return peerConnection?void peerConnection.setRemoteDescription(new RTCSessionDescription(a)):void console.error("peerConnection NOT exist!")},connect:function(){localStream&&this.socketReady?(this.sendOffer(),this.peerStarted=!0):console.log("localStream error")},hangUp:function(){console.log("Hang up."),this.stop()},stop:function(){peerConnection.close(),peerConnection=null,this.peerStarted=!1}}});new Vue({el:".toolbar",data:{palettes:[{color:"black",active:!0},{color:"red",active:!1},{color:"green",active:!1},{color:"blue",active:!1}],brushs:[{sizeName:"S",width:3,active:!0},{sizeName:"M",width:6,active:!1},{sizeName:"L",width:9,active:!1}]},ready:function(){newCanvas(),this.setColor(this.palettes[0]),this.setBrush(this.brushs[0])},methods:{setColor:function(a){this.clearActivePalette(),a.active=!0,ctx.beginPath(),ctx.strokeStyle=a.color},setBrush:function(a){this.clearActiveBrush(),a.active=!0,ctx.beginPath(),ctx.lineWidth=a.width},clearActivePalette:function(){$.each(this.palettes,function(a){a.active=!1})},clearActiveBrush:function(){$.each(this.brushs,function(a){a.active=!1})}}})}});